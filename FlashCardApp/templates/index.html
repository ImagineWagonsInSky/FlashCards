<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Study Tool</title>
    <link rel="stylesheet" type="text/css" href="../static/styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Flashcard Study Tool</h1>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                Select Topic
            </div>
            
            <div class="form-group">
                <select id="topic-select">
                    <option value="">-- Select a topic --</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="loadSelectedTopic()">Load Topic</button>
            
            <div class="section-title" style="margin-top: 2rem;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"></path>
                    <path d="M5 12h14"></path>
                </svg>
                Create New Topic
            </div>
            
            <div class="form-group">
                <input type="text" id="new-topic-input" placeholder="Enter new topic name">
            </div>
            
            <button class="btn btn-success" onclick="createNewTopic()">Create Topic</button>
            
            <div id="topic-message" class="message" style="display: none;"></div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'quiz')">Quiz</button>
            <button class="tab" onclick="openTab(event, 'add')">Add Flashcards</button>
            <button class="tab" onclick="openTab(event, 'view')">View All</button>
        </div>
        
        <div id="quiz" class="tab-content active">
            <div class="card">
                <div class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    Quiz Yourself
                </div>
                
                <div id="current-topic-display" class="topic-display">No topic selected</div>
                
                <div id="question-container">
                    <div class="flashcard">
                        <p id="current-question">Select a topic and click "New Question" to start</p>
                    </div>
                    
                    <div class="form-group">
                        <input type="text" id="answer-input" placeholder="Your answer">
                    </div>
                    
                    <div class="buttons-group">
                        <button class="btn btn-primary" onclick="checkAnswer()">Submit Answer</button>
                        <button class="btn btn-success" onclick="getNewQuestion()">New Question</button>
                    </div>
                </div>
                
                <div id="result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <div id="add" class="tab-content">
            <div class="card">
                <div class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14"></path>
                        <path d="M5 12h14"></path>
                    </svg>
                    Add New Flashcards
                </div>
                
                <div id="add-topic-display" class="topic-display">No topic selected</div>
                
                <div class="form-group">
                    <label for="new-question">Question:</label>
                    <textarea id="new-question" rows="3" placeholder="Enter your question"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="new-answer">Answer:</label>
                    <textarea id="new-answer" rows="3" placeholder="Enter the answer"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="addFlashcard()">Add Flashcard</button>
                <p id="add-result" class="message"></p>
            </div>
        </div>
        
        <div id="view" class="tab-content">
            <div class="card">
                <div class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    All Flashcards
                </div>
                
                <div id="view-topic-display" class="topic-display">No topic selected</div>
                
                <button class="btn btn-primary" onclick="refreshFlashcards()">Refresh List</button>
                
                <div id="flashcards-list" class="table-container">
                    <table id="flashcards-table">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Answer</th>
                            </tr>
                        </thead>
                        <tbody id="flashcards-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestion = "";
        let currentTopic = "";
        
        // Load topics when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTopics();
        });
        
        function loadTopics() {
            fetch('/get_topics')
                .then(response => response.json())
                .then(data => {
                    const topicSelect = document.getElementById('topic-select');
                    // Clear existing options except the default
                    while (topicSelect.options.length > 1) {
                        topicSelect.remove(1);
                    }
                    
                    // Add topics from the server
                    data.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        topicSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading topics:', error));
        }
        
        function loadSelectedTopic() {
            const topicSelect = document.getElementById('topic-select');
            const selectedTopic = topicSelect.value;
            
            if (!selectedTopic) {
                showTopicMessage('Please select a topic', 'error');
                return;
            }
            
            currentTopic = selectedTopic;
            updateTopicDisplays();
            showTopicMessage(`Topic "${selectedTopic}" loaded successfully`, 'success');
        }
        
        function createNewTopic() {
            const newTopicInput = document.getElementById('new-topic-input');
            const newTopic = newTopicInput.value.trim();
            
            if (!newTopic) {
                showTopicMessage('Please enter a topic name', 'error');
                return;
            }
            
            fetch('/create_topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic: newTopic
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showTopicMessage(data.error, 'error');
                    return;
                }
                
                showTopicMessage(`Topic "${newTopic}" created successfully`, 'success');
                newTopicInput.value = '';
                loadTopics();
                
                // Set the new topic as current
                setTimeout(() => {
                    const topicSelect = document.getElementById('topic-select');
                    topicSelect.value = newTopic;
                    currentTopic = newTopic;
                    updateTopicDisplays();
                }, 500);
            })
            .catch(error => {
                console.error('Error creating topic:', error);
                showTopicMessage('Error creating topic', 'error');
            });
        }
        
        function showTopicMessage(message, type) {
            const messageElement = document.getElementById('topic-message');
            messageElement.textContent = message;
            messageElement.className = type === 'error' ? 'message error-message' : 'message success-message';
            messageElement.style.display = 'block';
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }
        
        function updateTopicDisplays() {
            const displays = [
                document.getElementById('current-topic-display'),
                document.getElementById('add-topic-display'),
                document.getElementById('view-topic-display')
            ];
            
            displays.forEach(display => {
                if (currentTopic) {
                    display.innerHTML = `Current Topic: <span class="topic-badge">${currentTopic}</span>`;
                } else {
                    display.textContent = 'No topic selected';
                }
            });
        }
        
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === "view" && currentTopic) {
                refreshFlashcards();
            }
        }
        
        function getNewQuestion() {
            if (!currentTopic) {
                document.getElementById('current-question').textContent = "Please select a topic first";
                return;
            }
            
            fetch('/get_flashcard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic: currentTopic
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('current-question').textContent = data.error;
                    return;
                }
                currentQuestion = data.question;
                document.getElementById('current-question').textContent = data.question;
                document.getElementById('answer-input').value = '';
                document.getElementById('result').style.display = 'none';
            })
            .catch(error => console.error('Error:', error));
        }
        
        function checkAnswer() {
            const userAnswer = document.getElementById('answer-input').value;
            
            if (!currentTopic) {
                alert("Please select a topic first!");
                return;
            }
            
            if (!currentQuestion) {
                alert("Please get a question first!");
                return;
            }
            
            fetch('/check_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic: currentTopic,
                    question: currentQuestion,
                    answer: userAnswer
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultElement = document.getElementById('result');
                resultElement.style.display = 'block';
                
                if (data.error) {
                    resultElement.textContent = data.error;
                    resultElement.className = 'result incorrect';
                    return;
                }
                
                if (data.is_correct) {
                    resultElement.innerHTML = `<p>Correct!</p>`;
                    resultElement.className = 'result correct';
                } else {
                    resultElement.innerHTML = `
                        <p>Similarity: ${data.similarity}%</p>
                        <p>The correct answer is: ${data.correct_answer}</p>
                    `;
                    resultElement.className = 'result incorrect';
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function addFlashcard() {
            const question = document.getElementById('new-question').value;
            const answer = document.getElementById('new-answer').value;
            
            if (!currentTopic) {
                document.getElementById('add-result').textContent = "Please select a topic first!";
                document.getElementById('add-result').className = "message error-message";
                setTimeout(() => {
                    document.getElementById('add-result').textContent = "";
                    document.getElementById('add-result').className = "message";
                }, 3000);
                return;
            }
            
            if (!question || !answer) {
                document.getElementById('add-result').textContent = "Question and answer cannot be empty!";
                document.getElementById('add-result').className = "message error-message";
                setTimeout(() => {
                    document.getElementById('add-result').textContent = "";
                    document.getElementById('add-result').className = "message";
                }, 3000);
                return;
            }
            
            fetch('/add_flashcard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic: currentTopic,
                    question: question,
                    answer: answer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('add-result').textContent = data.error;
                    document.getElementById('add-result').className = "message error-message";
                    return;
                }
                
                document.getElementById('new-question').value = '';
                document.getElementById('new-answer').value = '';
                document.getElementById('add-result').textContent = "Flashcard added successfully!";
                document.getElementById('add-result').className = "message success-message";
                setTimeout(() => {
                    document.getElementById('add-result').textContent = "";
                    document.getElementById('add-result').className = "message";
                }, 3000);
            })
            .catch(error => console.error('Error:', error));
        }
        
        function refreshFlashcards() {
            if (!currentTopic) {
                return;
            }
            
            fetch('/get_all_flashcards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topic: currentTopic
                })
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('flashcards-tbody');
                tbody.innerHTML = '';
                
                if (data.error) {
                    return;
                }
                
                for (const question in data) {
                    const row = document.createElement('tr');
                    
                    const questionCell = document.createElement('td');
                    questionCell.textContent = question;
                    row.appendChild(questionCell);
                    
                    const answerCell = document.createElement('td');
                    answerCell.textContent = data[question];
                    row.appendChild(answerCell);
                    
                    tbody.appendChild(row);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>